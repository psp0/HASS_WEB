define(["require","exports","../common/scriptExecutionModels","../common/dataAccessService","../common/localizedConstants","ojs/ojbutton","ojs/ojknockout","ojs/ojmenu","ojs/ojformlayout","ojs/ojprogress-circle","ojs/ojchart","ojs/ojdialog","ojs/ojcheckboxset"],(function(require,e,t,s,a){"use strict";let r;return class{constructor(e){this.rtsmId=null,this.refreshTimerId=null,this.lc=a.LocalizedConstants.Instance,this.handlersField=new Map,r=this,r.rtsmId=parseInt(s.DataAccessService.instance.getElementValue("rtsmId")),r.resultsDataModel=e.data,r.handlers=new Map,r.handlers.set(t.OracleEventNames.scriptExecutionStarted,r.onScriptExecutionStarted),r.handlers.set(t.OracleEventNames.scriptExecutionFinished,r.onScriptExecutionFinished),r.handlers.set(t.OracleEventNames.scriptExecutionCancelled,r.onScriptExecutionCancelled),r.handlers.set(t.OracleEventNames.scriptExecutionBatchedMessage,r.onScriptExecutionBatchedMessage),r.handlers.set(t.OracleEventNames.scriptExecutionMessage,r.onScriptExecutionMessage),s.DataAccessService.instance.subscribe((e=>{if(e&&r.handlers.get(e.type)){const t=r.handlers.get(e.type);t&&t(e)}else s.DataAccessService.instance.logError(`Could not find handler for message ${e.type}`)})),window.addEventListener("message",(e=>{const t=e.data;if(t)switch(t.command){case"retrieve_statement_info":r.onReceivedStatementInfo(t.data);break;case"statement_detail_report":r.onReceivedStatementDetailReport(t.data);break;case"get_task_completion_status":r.onGetTaskCompletionStatus(t.data);break;case"execution_error":r.onExecutionError(t.data)}}));let n=r.resultsDataModel.requestStatus();n!==t.RtsmDataRequestStatus.ScriptStarted&&n!==t.RtsmDataRequestStatus.ScriptFinished&&n!==t.RtsmDataRequestStatus.ScriptCancelled&&n!==t.RtsmDataRequestStatus.ScriptBatchEvent||r.GetInfoForMonitoredStatement()}get handlers(){return r.handlersField}set handlers(e){r.handlersField=e}onScriptExecutionStarted(e){r.resultsDataModel.data(e.data),r.resultsDataModel.requestStatus(t.RtsmDataRequestStatus.ScriptStarted),r.resultsDataModel.rtsmExecutionId=e.data.rtsmExecutionId.trim()}onScriptExecutionFinished(e){r.resultsDataModel.data(e.data),r.resultsDataModel.requestStatus(t.RtsmDataRequestStatus.ScriptFinished)}onScriptExecutionCancelled(e){r.resultsDataModel.data(e.data),r.resultsDataModel.requestStatus(t.RtsmDataRequestStatus.ScriptCancelled)}onScriptExecutionBatchedMessage(e){r.resultsDataModel.data(e.data);let s="";const a=r.resultsDataModel.data();for(let e=0;e<a.messageList.length;e++){const r=a.messageList[e];if(r.requestMessageType==t.OracleEventNames.scriptExecutionMessage){let e=r;e.message&&(s+=e.message)}else{s=""}}r.resultsDataModel.error(s),r.GetInfoForMonitoredStatement()}onScriptExecutionMessage(e){r.resultsDataModel.data(e.data),r.GetInfoForMonitoredStatement()}async GetInfoForMonitoredStatement(){const e=new t.MessageBase;e.type=t.MessageName.rtsmActionRequest;const a=new t.RTSMRequestParameters;return a.command="retrieve_statement_info",a.rtsmId=r.rtsmId,a.rtsmExecutionId=r.resultsDataModel.rtsmExecutionId,e.data=a,await s.DataAccessService.instance.send(e)}async GetTaskCompletionStatus(){const e=new t.MessageBase;e.type=t.MessageName.rtsmActionRequest;const a=new t.RTSMRequestParameters;return a.command="get_task_completion_status",a.rtsmId=r.rtsmId,a.sqlId=r.sqlId,a.sqlExecId=r.sqlExecId,a.sqlExecStart=r.sqlExecStart,e.data=a,await s.DataAccessService.instance.send(e)}async GetTaskDetailedReport(){const e=new t.MessageBase;e.type=t.MessageName.rtsmActionRequest;const a=new t.RTSMRequestParameters;return a.command="statement_detail_report",a.rtsmId=r.rtsmId,a.sqlId=r.sqlId,a.sqlExecId=r.sqlExecId,a.sqlExecStart=r.sqlExecStart,e.data=a,await s.DataAccessService.instance.send(e)}async onReceivedStatementInfo(e){let s=e;if(s.length>0){r.resultsDataModel.requestStatus(t.RtsmDataRequestStatus.ScriptInfoReceived);let e=s[0];r.sqlId=e.SQL_ID,r.sqlExecId=e.SQL_EXEC_ID,r.sqlExecStart=e.SQL_EXEC_START,r.GetTaskCompletionStatus()}else{let e=r.resultsDataModel.error();e&&0!==e.length||r.resultsDataModel.error("Information about monitored script could not be retrieved.\nScript execution could have failed."),r.resultsDataModel.requestStatus(t.RtsmDataRequestStatus.ScriptExecutionError)}}async onReceivedStatementDetailReport(e){r.resultsDataModel.requestStatus(t.RtsmDataRequestStatus.ScriptReportReceived);let s=e;document.getElementById("statementDetailReport").srcdoc=s}async onGetTaskCompletionStatus(e){"EXECUTING"===e||"QUEUED"===e?null===r.refreshTimerId&&(r.refreshTimerId=setInterval((async()=>{r.GetTaskCompletionStatus()}),6e4)):null!==r.refreshTimerId&&(clearInterval(r.refreshTimerId),r.refreshTimerId=null),r.GetTaskDetailedReport()}async onExecutionError(e){r.resultsDataModel.error(e.toString()),r.resultsDataModel.requestStatus(t.RtsmDataRequestStatus.ScriptExecutionError)}}}));